#!/bin/bash -u

# Path to the firefox profile we will be using
debug=false
ffprofile_src=firefox-profile
ffprofile=voltage-ffprofile.$$
mem_max=512
mem_min=256
port=4444
remote=lib/selenium-server.jar
timeout=300

# How do you use this thing:
function usage {
    THIS=$0

    echo
    echo "Usage: $THIS"
    echo "Arguments available:
    -d  Debug mode (enables the firebug extension)
    -f  Path to firefox profile
    -m  Min memory to be used by the JVM (default is: $mem_min)
    -p  Port (tcp) to run the selenium-server on (default is 4444)
    -r  Path to remote (selenium-server.jar)
    -t  Timeout honored by the selenium-server (default is 300)
    -M  Max memory to be used by the JVM (default is: $mem_max)
    -h  Help (this)

    Examples:

    user# $THIS
    user# $THIS -p 4445
    user# $THIS -p 4445 -d
    user# $THIS -f ~/path/to/some/selenium-server.jar
    user# $THIS -t 1000
    "

    exit 1
}

function clean {
    echo -n "Cleaning up..."
    rm -rf $ffprofile
    echo
}

# Copy the firefox profile to tmp
function prepare_ffprofile {
    trap clean INT TERM EXIT

    if [ $(uname | cut -c 1-6) == 'CYGWIN' ]; then
        ffprofile="C:\tmp\$ffprofile"
    else
        ffprofile="/tmp/$ffprofile"
    fi

    cp -R $ffprofile_src $ffprofile

    # After the swtich to p4, we don't want to commit files/dirs
    # with '@' in their names since '@' is a p4 metacharacter.
    # So store without everything after @ and move to the original
    # dirs at runtime for the profile and firebug
    mv $ffprofile/extensions/automation-tools \
       $ffprofile/extensions/automation-tools@reardencommerce.com

    if [ "$debug" == true ]; then
        # Enable firebug
        cp -R firefox-addons/firebug \
            $ffprofile/extensions/firebug@software.joehewitt.com
    fi
}

# Start the selenium-server using args currently set
function start {
    prepare_ffprofile

    java \
         -Xms${mem_min}M \
         -Xmx${mem_max}M \
         -jar $remote \
         -ensureCleanSession \
         -port $port \
         -singleWindow \
         -timeout $timeout \
         -trustAllSSLCertificates \
         -firefoxProfileTemplate $ffprofile
}

# Fetch any passed in arguments:
while getopts "df:hm:p:r:t:M:" options; do
    case $options in
        d ) debug=true;;
        f ) ffprofile_src=$OPTARG;;
        m ) mem_min=$OPTARG;;
        p ) port=$OPTARG;;
        p ) timeout=$OPTARG;;
        r ) remote=$OPTARG;;
        M ) mem_max=$OPTARG;;
        * ) usage
        ;;
    esac
done

# Validate the remote control
if [ ! -f "$remote" ]; then
    echo "Please set a valid selenium-server.jar"
    exit
fi

# Validate we found a firefox profile
if [ ! -d "$ffprofile_src" ]; then
    echo "Please set a valid firefox profile"
    exit
fi
